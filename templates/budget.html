{% extends "base.html" %}

{% block title %}Budget View | OVEC Budget System{% endblock %}

{% block content %}
<!-- Header -->
<header class="page-header">
    <div class="header-left">
        <h1>{{ plant_name }} <span class="subtitle">{{ year }} Budget</span></h1>
        <span class="readonly-badge">Read Only</span>
    </div>
    <div class="header-right">
        <button class="btn btn-secondary" onclick="exportBudget()">Export</button>
        <button class="btn btn-primary" onclick="location.reload()">Refresh</button>
    </div>
</header>

<!-- Budget Summary -->
<div class="budget-summary">
    <div class="summary-item">
        <span class="label">Original Budget</span>
        <span class="value">${{ "{:,.0f}".format(total_budget) }}</span>
    </div>
    <div class="summary-item">
        <span class="label">Amendments</span>
        <span class="value amendment">$0</span>
    </div>
    <div class="summary-item">
        <span class="label">Reallocations</span>
        <span class="value reallocation">$0</span>
    </div>
    <div class="summary-item highlight">
        <span class="label">Current Budget</span>
        <span class="value">${{ "{:,.0f}".format(total_budget) }}</span>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-left">
        <input type="text" class="search-input" placeholder="Search accounts..." id="searchInput">
        <select class="filter-select" id="deptFilter">
            <option value="">All Departments</option>
            {% for dept in departments %}
            <option value="{{ dept.dept_code }}">{{ dept.dept_code }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Budget Grid -->
<div class="grid-container readonly-grid">
    <table class="data-grid">
        <thead>
            <tr>
                <th class="sticky-col col-account">Account</th>
                <th class="sticky-col col-acctdesc">Acct Desc</th>
                <th class="sticky-col col-desc">Description</th>
                {% for m in range(1, 13) %}
                <th class="month-col align-right">{{ month_names[m] }}</th>
                {% endfor %}
                <th class="total-col align-right">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for dept in departments %}
            <!-- Department Header -->
            <tr class="group-header">
                <td class="sticky-col col-account" colspan="16">
                    {{ dept.dept_code }} - ${{ "{:,.0f}".format(dept.total) }}
                </td>
            </tr>
            {% for line in dept.lines %}
            <tr {% if line.total > 50000 %}class="highlight-row"{% endif %}>
                <td class="sticky-col col-account">
                    <span class="account-num">{{ line.account }}</span>
                </td>
                <td class="sticky-col col-acctdesc" title="{{ line.account_desc }}">{{ line.account_desc }}</td>
                <td class="sticky-col col-desc" title="{{ line.description }}">{{ line.description }}</td>
                {% for i in range(12) %}
                <td class="readonly-cell">{{ "{:,.0f}".format(line.months[i]) if line.months[i] != 0 else "" }}</td>
                {% endfor %}
                <td class="total-col {% if line.total > 50000 %}highlight{% endif %}">
                    {{ "{:,.0f}".format(line.total) }}
                </td>
            </tr>
            {% endfor %}
            <!-- Department Subtotal -->
            <tr class="subtotal-row">
                <td class="sticky-col col-account" colspan="3">{{ dept.dept_code }} Subtotal</td>
                {% for i in range(12) %}
                <td class="readonly-cell">{{ "{:,.0f}".format(dept.monthly_totals[i]) }}</td>
                {% endfor %}
                <td class="total-col">{{ "{:,.0f}".format(dept.total) }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="totals-row">
                <td class="sticky-col col-account" colspan="3">PLANT TOTAL</td>
                {% for i in range(12) %}
                <td class="readonly-cell">{{ "{:,.0f}".format(grand_monthly_totals[i]) }}</td>
                {% endfor %}
                <td class="total-col">{{ "{:,.0f}".format(total_budget) }}</td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Footer -->
<footer class="page-footer">
    <div class="footer-left">
        <span class="item-count">{{ department_count }} departments &bull; {{ line_count }} budget lines</span>
    </div>
    <div class="footer-right">
        <span class="last-updated">Last updated: {{ last_updated }}</span>
    </div>
</footer>
{% endblock %}

{% block scripts %}
<script>
function exportBudget() {
    window.location.href = '/api/export/budget/{{ plant_code }}/{{ year }}';
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.data-grid tbody tr:not(.group-header):not(.subtotal-row)');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Department filter
document.getElementById('deptFilter').addEventListener('change', function(e) {
    const dept = e.target.value;
    const groups = document.querySelectorAll('.group-header');
    
    groups.forEach(header => {
        const deptName = header.textContent.split(' - ')[0].trim();
        const showGroup = !dept || deptName === dept;
        
        // Show/hide header
        header.style.display = showGroup ? '' : 'none';
        
        // Show/hide all rows until next header
        let sibling = header.nextElementSibling;
        while (sibling && !sibling.classList.contains('group-header')) {
            sibling.style.display = showGroup ? '' : 'none';
            sibling = sibling.nextElementSibling;
        }
    });
});
</script>
{% endblock %}

