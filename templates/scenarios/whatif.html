{% extends "base.html" %}

{% block title %}What-If Analysis - OVEC{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/styles.css">

<style>
.whatif-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
}

.whatif-header {
    margin-bottom: 24px;
}

.whatif-header h1 {
    margin: 0;
    font-size: 28px;
    color: #1e3a5f;
}

.whatif-header p {
    color: #6b7280;
    margin-top: 8px;
}

.year-selector {
    display: flex;
    gap: 16px;
    align-items: center;
    margin-bottom: 24px;
    padding: 16px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.year-selector label {
    font-weight: 600;
    color: #374151;
}

.year-selector select {
    padding: 8px 16px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}

.whatif-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
}

.whatif-card {
    background: white;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    overflow: hidden;
    transition: all 0.2s ease;
    cursor: pointer;
}

.whatif-card:hover {
    border-color: #2d6a4f;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.whatif-card.loading {
    opacity: 0.6;
    pointer-events: none;
}

.whatif-card-header {
    padding: 16px;
    background: linear-gradient(135deg, #f8fafc 0%, #f0f4f8 100%);
    border-bottom: 1px solid #e5e7eb;
}

.whatif-card-header h3 {
    margin: 0;
    font-size: 16px;
    color: #1e3a5f;
}

.whatif-card-header p {
    margin: 4px 0 0 0;
    font-size: 13px;
    color: #6b7280;
}

.whatif-card-body {
    padding: 16px;
}

.whatif-result {
    display: none;
}

.whatif-result.active {
    display: block;
}

.whatif-delta {
    text-align: center;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 12px;
}

.whatif-delta.increase {
    background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
}

.whatif-delta.decrease {
    background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
}

.whatif-delta .value {
    font-size: 28px;
    font-weight: 700;
}

.whatif-delta.increase .value {
    color: #dc2626;
}

.whatif-delta.decrease .value {
    color: #10b981;
}

.whatif-delta .label {
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
}

.whatif-details {
    font-size: 13px;
    color: #6b7280;
}

.whatif-details .row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    border-bottom: 1px solid #f3f4f6;
}

.whatif-placeholder {
    text-align: center;
    padding: 24px;
    color: #6b7280;
    font-size: 14px;
}

.whatif-placeholder span {
    font-size: 32px;
    display: block;
    margin-bottom: 8px;
}

.base-case-card {
    background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
    color: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
}

.base-case-card h2 {
    margin: 0 0 16px 0;
    font-size: 18px;
}

.base-case-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
}

.base-stat {
    text-align: center;
}

.base-stat .value {
    font-size: 24px;
    font-weight: 700;
}

.base-stat .label {
    font-size: 12px;
    opacity: 0.8;
    margin-top: 4px;
}
</style>

<div class="whatif-container">
    <div class="whatif-header">
        <h1>What-If Analysis</h1>
        <p>Click a scenario to see the instant impact on fuel costs.</p>
    </div>
    
    <div class="year-selector">
        <label for="year">Analysis Year:</label>
        <select id="year" onchange="updateBaseCase()">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
        </select>
        <span id="loading-indicator" style="display: none;">Calculating...</span>
    </div>
    
    <div class="base-case-card">
        <h2>Base Case (Current Inputs)</h2>
        <div class="base-case-stats">
            <div class="base-stat">
                <div class="value" id="base-cost">‚Äî</div>
                <div class="label">Total Fuel Cost</div>
            </div>
            <div class="base-stat">
                <div class="value" id="base-mwh">‚Äî</div>
                <div class="label">Net Generation (MWh)</div>
            </div>
            <div class="base-stat">
                <div class="value" id="base-unit-cost">‚Äî</div>
                <div class="label">$/MWh</div>
            </div>
        </div>
    </div>
    
    <div class="whatif-grid">
        <!-- Extended Outage -->
        <div class="whatif-card" onclick="runWhatIf('extended_outage', {unit: 6, month: 6, value: 30})">
            <div class="whatif-card-header">
                <h3>üîß Extended Unit Outage</h3>
                <p>Clifty Unit 6 has a 30-day outage in June</p>
            </div>
            <div class="whatif-card-body">
                <div class="whatif-placeholder" id="result-extended_outage-placeholder">
                    <span>üëÜ</span>
                    Click to calculate
                </div>
                <div class="whatif-result" id="result-extended_outage"></div>
            </div>
        </div>
        
        <!-- Higher Use Factor -->
        <div class="whatif-card" onclick="runWhatIf('higher_use_factor', {})">
            <div class="whatif-card-header">
                <h3>üìà Higher Use Factor</h3>
                <p>All units operate at 90% use factor</p>
            </div>
            <div class="whatif-card-body">
                <div class="whatif-placeholder" id="result-higher_use_factor-placeholder">
                    <span>üëÜ</span>
                    Click to calculate
                </div>
                <div class="whatif-result" id="result-higher_use_factor"></div>
            </div>
        </div>
        
        <!-- Lower Use Factor -->
        <div class="whatif-card" onclick="runWhatIf('lower_use_factor', {})">
            <div class="whatif-card-header">
                <h3>üìâ Lower Use Factor</h3>
                <p>All units operate at 75% use factor</p>
            </div>
            <div class="whatif-card-body">
                <div class="whatif-placeholder" id="result-lower_use_factor-placeholder">
                    <span>üëÜ</span>
                    Click to calculate
                </div>
                <div class="whatif-result" id="result-lower_use_factor"></div>
            </div>
        </div>
        
        <!-- Coal Price Increase -->
        <div class="whatif-card" onclick="runWhatIf('coal_price_increase', {value: 66})">
            <div class="whatif-card-header">
                <h3>üí∞ Coal Price +$5/ton</h3>
                <p>Delivered coal price increases from $61 to $66/ton</p>
            </div>
            <div class="whatif-card-body">
                <div class="whatif-placeholder" id="result-coal_price_increase-placeholder">
                    <span>üëÜ</span>
                    Click to calculate
                </div>
                <div class="whatif-result" id="result-coal_price_increase"></div>
            </div>
        </div>
        
        <!-- Coal Price Decrease -->
        <div class="whatif-card" onclick="runWhatIf('coal_price_decrease', {value: 56})">
            <div class="whatif-card-header">
                <h3>üíµ Coal Price -$5/ton</h3>
                <p>Delivered coal price decreases from $61 to $56/ton</p>
            </div>
            <div class="whatif-card-body">
                <div class="whatif-placeholder" id="result-coal_price_decrease-placeholder">
                    <span>üëÜ</span>
                    Click to calculate
                </div>
                <div class="whatif-result" id="result-coal_price_decrease"></div>
            </div>
        </div>
        
        <!-- Heat Rate Improvement -->
        <div class="whatif-card" onclick="runWhatIf('heat_rate_improvement', {})">
            <div class="whatif-card-header">
                <h3>‚ö° Heat Rate Improvement</h3>
                <p>Heat rates improve by 100 BTU/kWh</p>
            </div>
            <div class="whatif-card-body">
                <div class="whatif-placeholder" id="result-heat_rate_improvement-placeholder">
                    <span>üëÜ</span>
                    Click to calculate
                </div>
                <div class="whatif-result" id="result-heat_rate_improvement"></div>
            </div>
        </div>
        
        <!-- Unit 6 Summer Run -->
        <div class="whatif-card" onclick="runWhatIf('unit6_summer_run', {})">
            <div class="whatif-card-header">
                <h3>‚òÄÔ∏è Unit 6 Summer Operation</h3>
                <p>Clifty Unit 6 runs at 50% during ozone season (May-Sep)</p>
            </div>
            <div class="whatif-card-body">
                <div class="whatif-placeholder" id="result-unit6_summer_run-placeholder">
                    <span>üëÜ</span>
                    Click to calculate
                </div>
                <div class="whatif-result" id="result-unit6_summer_run"></div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 24px;">
        <a href="/scenarios" class="btn btn-secondary">‚Üê Back to Scenarios</a>
    </div>
</div>

<script>
let baseCase = null;

async function updateBaseCase() {
    const year = document.getElementById('year').value;
    document.getElementById('loading-indicator').style.display = 'inline';
    
    // Reset all results
    document.querySelectorAll('.whatif-result').forEach(el => {
        el.classList.remove('active');
        el.innerHTML = '';
    });
    document.querySelectorAll('.whatif-placeholder').forEach(el => {
        el.style.display = 'block';
    });
    
    try {
        // For now, use placeholder values - would call API to get base case
        baseCase = {
            total_cost: 180000000,
            total_mwh: 7500000,
            cost_per_mwh: 24.00
        };
        
        document.getElementById('base-cost').textContent = '$' + (baseCase.total_cost / 1000000).toFixed(1) + 'M';
        document.getElementById('base-mwh').textContent = (baseCase.total_mwh / 1000000).toFixed(2) + 'M';
        document.getElementById('base-unit-cost').textContent = '$' + baseCase.cost_per_mwh.toFixed(2);
    } catch (error) {
        console.error('Error loading base case:', error);
    } finally {
        document.getElementById('loading-indicator').style.display = 'none';
    }
}

async function runWhatIf(scenarioType, params) {
    const year = document.getElementById('year').value;
    const card = event.currentTarget;
    const resultDiv = document.getElementById(`result-${scenarioType}`);
    const placeholderDiv = document.getElementById(`result-${scenarioType}-placeholder`);
    
    // Mark as loading
    card.classList.add('loading');
    
    try {
        const response = await fetch(`/api/whatif/quick/${scenarioType}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ year: parseInt(year), ...params })
        });
        
        if (!response.ok) throw new Error('Calculation failed');
        
        const data = await response.json();
        
        // Hide placeholder, show result
        placeholderDiv.style.display = 'none';
        resultDiv.classList.add('active');
        
        const deltaClass = data.delta.cost > 0 ? 'increase' : 'decrease';
        const deltaSign = data.delta.cost > 0 ? '+' : '';
        
        resultDiv.innerHTML = `
            <div class="whatif-delta ${deltaClass}">
                <div class="value">${deltaSign}$${(data.delta.cost / 1000000).toFixed(2)}M</div>
                <div class="label">${deltaSign}${data.delta.cost_pct.toFixed(1)}% vs base case</div>
            </div>
            <div class="whatif-details">
                <div class="row">
                    <span>Modified Cost</span>
                    <span>$${(data.modified_case.total_cost / 1000000).toFixed(1)}M</span>
                </div>
                <div class="row">
                    <span>Generation Change</span>
                    <span>${(data.delta.mwh / 1000).toFixed(0)} MWh</span>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error running what-if:', error);
        resultDiv.innerHTML = '<div style="color: #dc2626; text-align: center;">Error calculating. Try again.</div>';
        resultDiv.classList.add('active');
        placeholderDiv.style.display = 'none';
    } finally {
        card.classList.remove('loading');
    }
}

// Load base case on page load
document.addEventListener('DOMContentLoaded', updateBaseCase);
</script>
{% endblock %}

