{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>Scenarios</h1>
    <p>Manage forecast scenarios - Budget, Internal, and External forecasts</p>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">All Scenarios</h2>
        <button class="btn btn-primary" onclick="document.getElementById('newScenarioModal').style.display='block'">
            + New Scenario
        </button>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Version</th>
                    <th>Created</th>
                    <th>Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for scenario in scenarios %}
                <tr>
                    <td><strong><a href="/scenarios/{{ scenario.id }}">{{ scenario.name }}</a></strong></td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">{{ scenario.description or '-' }}</td>
                    <td>
                        {% if scenario.scenario_type.value == 'budget' %}
                        <span class="badge badge-budget">Budget</span>
                        {% elif scenario.scenario_type.value == 'internal_forecast' %}
                        <span class="badge badge-internal">Internal</span>
                        {% else %}
                        <span class="badge badge-external">External</span>
                        {% endif %}
                    </td>
                    <td><span class="badge badge-{{ scenario.status.value }}">{{ scenario.status.value|title }}</span></td>
                    <td>v{{ scenario.version }}</td>
                    <td>{{ scenario.created_at.strftime('%Y-%m-%d') if scenario.created_at else 'N/A' }}</td>
                    <td>{{ scenario.updated_at.strftime('%Y-%m-%d %H:%M') if scenario.updated_at else 'N/A' }}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="/scenarios/{{ scenario.id }}" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">View</a>
                            <a href="/api/reports/sponsor/{{ scenario.id }}" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Export</a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" style="text-align: center; padding: 2rem;">
                        No scenarios found. Create one to get started.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Scenario Type Legend -->
<div class="grid grid-3">
    <div class="card">
        <h3 style="color: #1e40af; margin-bottom: 0.5rem;">Budget</h3>
        <p style="color: var(--text-light); font-size: 0.9rem;">Official approved budget for the fiscal year. Typically locked after approval.</p>
    </div>
    <div class="card">
        <h3 style="color: #92400e; margin-bottom: 0.5rem;">Internal Forecast</h3>
        <p style="color: var(--text-light); font-size: 0.9rem;">Working forecast for internal management. Updated monthly with latest assumptions.</p>
    </div>
    <div class="card">
        <h3 style="color: #065f46; margin-bottom: 0.5rem;">External Forecast</h3>
        <p style="color: var(--text-light); font-size: 0.9rem;">Forecast shared with sponsors. Updated twice yearly or upon request.</p>
    </div>
</div>

<!-- New Scenario Modal (simple) -->
<div id="newScenarioModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 12px; min-width: 400px;">
        <h2 style="margin-bottom: 1rem;">Create New Scenario</h2>
        <form action="/api/scenarios" method="POST" id="newScenarioForm">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" name="name" class="form-control" required placeholder="e.g., 2025 Budget">
            </div>
            <div class="form-group">
                <label class="form-label">Type</label>
                <select name="scenario_type" class="form-control" required>
                    <option value="budget">Budget</option>
                    <option value="internal_forecast">Internal Forecast</option>
                    <option value="external_forecast">External Forecast</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" rows="3" placeholder="Optional description..."></textarea>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-outline" onclick="document.getElementById('newScenarioModal').style.display='none'">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Scenario</button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('newScenarioForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const data = {
        name: form.name.value,
        scenario_type: form.scenario_type.value,
        description: form.description.value || null
    };
    
    try {
        const response = await fetch('/api/scenarios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Error creating scenario');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
});
</script>
{% endblock %}

