{% extends "base.html" %}

{% block title %}Coal Inventory - {{ plant_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-left">
        <h1>Coal Inventory <span class="subtitle">{{ plant_name }}</span></h1>
    </div>
    <div class="header-right">
        <span class="card-subtext">Year: {{ year }}</span>
    </div>
</div>

<!-- Summary Bar (compact like Fuel View) -->
<div class="budget-summary">
    <div class="summary-item highlight">
        <span class="label">Annual Supply</span>
        <span class="value">{{ "{:,.0f}".format(annual.total_tons) }} tons</span>
    </div>
    <div class="summary-item highlight">
        <span class="label">Total Cost</span>
        <span class="value">${{ "{:,.0f}".format(annual.total_cost) }}</span>
    </div>
    <div class="summary-item">
        <span class="label">Avg $/Ton</span>
        <span class="value">${{ "{:.2f}".format(annual.avg_cost_per_ton) }}</span>
    </div>
    <div class="summary-item">
        <span class="label">Avg Days Supply</span>
        <span class="value">{{ annual.avg_days_supply|round(0)|int }} days</span>
    </div>
    <div class="summary-item">
        <span class="label">Sources</span>
        <span class="value">{{ monthly_data|map(attribute='source_count')|max }}</span>
    </div>
</div>

<!-- Monthly Inventory Table -->
<h2 class="section-title">Monthly Coal Supply</h2>
<div class="grid-container" style="overflow-x: auto;">
    <table class="data-grid">
        <thead>
            <tr>
                <th></th>
                {% for m in monthly_data %}
                <th class="align-right">{{ m.month_name[:3] }}</th>
                {% endfor %}
                <th class="align-right total-col">Annual</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Beginning Inv (tons)</td>
                {% for m in monthly_data %}
                <td class="align-right">{{ "{:,.0f}".format(m.beginning_inventory) }}</td>
                {% endfor %}
                <td class="align-right total-col">{{ "{:,.0f}".format(monthly_data[0].beginning_inventory) if monthly_data else '-' }}</td>
            </tr>
            <tr>
                <td>Deliveries (tons)</td>
                {% for m in monthly_data %}
                <td class="align-right">{{ "{:,.0f}".format(m.total_tons) }}</td>
                {% endfor %}
                <td class="align-right total-col">{{ "{:,.0f}".format(annual.total_tons) }}</td>
            </tr>
            <tr>
                <td>Consumption (tons)</td>
                {% for m in monthly_data %}
                <td class="align-right">{{ "{:,.0f}".format(m.consumption|default(0)) }}</td>
                {% endfor %}
                <td class="align-right total-col">{{ "{:,.0f}".format(annual.total_consumption|default(0)) }}</td>
            </tr>
            <tr>
                <td>Ending Inv (tons)</td>
                {% for m in monthly_data %}
                <td class="align-right">{{ "{:,.0f}".format(m.ending_inventory) }}</td>
                {% endfor %}
                <td class="align-right total-col">{{ "{:,.0f}".format(monthly_data[-1].ending_inventory) if monthly_data else '-' }}</td>
            </tr>
            <tr class="totals-row">
                <td><strong>Days Supply</strong></td>
                {% for m in monthly_data %}
                {% set days_class = 'unfavorable' if m.days_supply < 30 else ('neutral' if m.days_supply < 50 else 'favorable') %}
                <td class="align-right {{ days_class }}" style="font-weight:600">{{ m.days_supply|round(0)|int }}</td>
                {% endfor %}
                <td class="align-right total-col" style="font-weight:600">{{ annual.avg_days_supply|round(0)|int }} avg</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Cost Table -->
<h2 class="section-title">Monthly Coal Costs</h2>
<div class="grid-container" style="overflow-x: auto;">
    <table class="data-grid">
        <thead>
            <tr>
                <th></th>
                {% for m in monthly_data %}
                <th class="align-right">{{ m.month_name[:3] }}</th>
                {% endfor %}
                <th class="align-right total-col">Annual</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Total Cost</td>
                {% for m in monthly_data %}
                <td class="align-right">${{ "{:,.0f}".format(m.total_cost) }}</td>
                {% endfor %}
                <td class="align-right total-col">${{ "{:,.0f}".format(annual.total_cost) }}</td>
            </tr>
            <tr>
                <td>$/Ton</td>
                {% for m in monthly_data %}
                <td class="align-right">${{ "{:.2f}".format(m.avg_cost_per_ton) if m.avg_cost_per_ton else '-' }}</td>
                {% endfor %}
                <td class="align-right total-col">${{ "{:.2f}".format(annual.avg_cost_per_ton) }}</td>
            </tr>
            <tr>
                <td>Avg BTU/lb</td>
                {% for m in monthly_data %}
                <td class="align-right">{{ "{:,.0f}".format(m.avg_btu) if m.avg_btu else '-' }}</td>
                {% endfor %}
                <td class="align-right total-col">-</td>
            </tr>
            <tr>
                <td>Sources</td>
                {% for m in monthly_data %}
                <td class="align-right">{{ m.source_count }}</td>
                {% endfor %}
                <td class="align-right total-col">-</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Inventory Chart (compact) -->
<h2 class="section-title">Monthly Ending Inventory</h2>
<div class="chart-container" style="padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #d1d9e6;">
    <div style="display: flex; height: 120px; align-items: flex-end; gap: 0.25rem;">
        {% set max_inv = monthly_data|map(attribute='ending_inventory')|max|default(100000) %}
        {% set max_inv = max_inv if max_inv > 0 else 1 %}
        {% for m in monthly_data %}
        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
            <div style="width: 100%; background: linear-gradient(180deg, #2d4a6f 0%, #1e3a5f 100%); border-radius: 2px 2px 0 0; min-height: 3px; height: {{ (m.ending_inventory / max_inv * 100)|round(0) }}px;"></div>
            <div style="font-size: 0.65rem; color: #6b7280; margin-top: 0.25rem;">{{ m.month_name[:3] }}</div>
            <div style="font-size: 0.6rem; color: #1e3a5f; font-weight: 600;">{{ (m.ending_inventory / 1000)|round(0) }}K</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Days Supply Legend -->
<div style="margin-top:1rem;display:flex;gap:2rem;color:#6b7280;font-size:0.8rem">
    <div><span style="display:inline-block;padding:0.2rem 0.5rem;border-radius:4px;background:#fef2f2;color:#dc2626;font-size:0.75rem;font-weight:600">Low</span> &lt; 30 days</div>
    <div><span style="display:inline-block;padding:0.2rem 0.5rem;border-radius:4px;background:#fffbeb;color:#d97706;font-size:0.75rem;font-weight:600">Medium</span> 30-49 days</div>
    <div><span style="display:inline-block;padding:0.2rem 0.5rem;border-radius:4px;background:#f0fdf4;color:#16a34a;font-size:0.75rem;font-weight:600">Good</span> 50+ days</div>
</div>
{% endblock %}
