{% extends "fuel_forecast/_layout.html" %}

{% block step_content %}
<style>
.use-factor-grid {
    display: grid;
    grid-template-columns: 80px repeat(12, 1fr);
    gap: 2px;
    background: #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    margin-top: 16px;
}

.grid-header {
    background: #1e3a5f;
    color: white;
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    font-size: 12px;
}

.grid-label {
    background: #f3f4f6;
    padding: 12px 8px;
    font-weight: 500;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.grid-cell {
    background: white;
    padding: 8px;
}

.grid-cell input {
    width: 100%;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    padding: 8px;
    text-align: center;
    font-size: 14px;
    font-family: 'JetBrains Mono', monospace;
}

.grid-cell input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.grid-cell input.ozone-active {
    background: #fef3c7;
    border-color: #f59e0b;
}

.grid-cell input.changed {
    border-color: #10b981;
    background: #ecfdf5;
}

.ozone-indicator {
    display: inline-block;
    padding: 2px 6px;
    background: #fef3c7;
    color: #92400e;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    margin-left: 4px;
}

.plant-section {
    margin-bottom: 32px;
}

.plant-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
    color: white;
    border-radius: 8px;
    margin-bottom: 8px;
}

.plant-name {
    font-size: 18px;
    font-weight: 600;
}

.plant-badge {
    padding: 4px 10px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    font-size: 12px;
}

.quick-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    margin-bottom: 16px;
}

.quick-action-btn {
    padding: 8px 16px;
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.quick-action-btn:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
}

.quick-action-btn.active {
    background: #dbeafe;
    border-color: #3b82f6;
    color: #1e40af;
}

.legend {
    display: flex;
    gap: 16px;
    margin-top: 12px;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
    font-size: 12px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

.legend-color.ozone {
    background: #fef3c7;
    border: 1px solid #f59e0b;
}

.legend-color.changed {
    background: #ecfdf5;
    border: 1px solid #10b981;
}

.summary-panel {
    margin-top: 24px;
    padding: 16px;
    background: linear-gradient(135deg, #f0f4f8 0%, #e8eef5 100%);
    border-radius: 8px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e5e7eb;
}

.summary-row:last-child {
    border-bottom: none;
}

.summary-label {
    font-size: 14px;
    color: #6b7280;
}

.summary-value {
    font-size: 14px;
    font-weight: 600;
    color: #1e3a5f;
    font-family: 'JetBrains Mono', monospace;
}
</style>

<div class="step-card">
    <div class="step-card-header">
        <h2>Use Factor Configuration</h2>
        <p>Set monthly use factors for each plant. Use factors determine expected generation as a percentage of available capacity.</p>
    </div>
    
    <form method="POST" action="/fuel-forecast/{{ session_id }}/step/4" id="use-factor-form">
        <div class="step-card-body">
            
            <!-- Kyger Creek Section -->
            <div class="plant-section" data-plant-id="1">
                <div class="plant-section-header">
                    <span class="plant-name">Kyger Creek</span>
                    <span class="plant-badge">5 Units with SCR</span>
                </div>
                
                <div class="quick-actions">
                    <button type="button" class="quick-action-btn" onclick="applyFlat(1, 85)">Flat 85%</button>
                    <button type="button" class="quick-action-btn" onclick="applyFlat(1, 80)">Flat 80%</button>
                    <button type="button" class="quick-action-btn" onclick="applySeasonal(1)">Seasonal</button>
                    <button type="button" class="quick-action-btn" onclick="copyFromPrior(1)">Copy Prior Year</button>
                </div>
                
                <div class="use-factor-grid" id="grid-kyger">
                    <!-- Headers -->
                    <div class="grid-header">Month</div>
                    {% for m in range(1, 13) %}
                    <div class="grid-header">
                        {{ ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m-1] }}
                        {% if m >= 5 and m <= 9 %}<span class="ozone-indicator">O3</span>{% endif %}
                    </div>
                    {% endfor %}
                    
                    <!-- Base Use Factor Row -->
                    <div class="grid-label">Base</div>
                    {% for m in range(1, 13) %}
                    <div class="grid-cell">
                        <input type="number" 
                               name="kc_base_{{ m }}" 
                               id="kc_base_{{ m }}"
                               value="{{ kyger_factors[m].base if kyger_factors else 85 }}"
                               min="0" max="100" step="1"
                               data-plant="kc" data-type="base" data-month="{{ m }}"
                               onchange="markChanged(this)">
                    </div>
                    {% endfor %}
                </div>
                
                <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                    All Kyger Creek units have SCR. Base use factor applies to all units year-round.
                </p>
            </div>
            
            <!-- Clifty Creek Section -->
            <div class="plant-section" data-plant-id="2">
                <div class="plant-section-header">
                    <span class="plant-name">Clifty Creek</span>
                    <span class="plant-badge">5 Units with SCR + 1 Unit without</span>
                </div>
                
                <div class="quick-actions">
                    <button type="button" class="quick-action-btn" onclick="applyFlat(2, 85)">Flat 85%</button>
                    <button type="button" class="quick-action-btn" onclick="applyFlat(2, 80)">Flat 80%</button>
                    <button type="button" class="quick-action-btn" onclick="applySeasonal(2)">Seasonal</button>
                    <button type="button" class="quick-action-btn" onclick="applyUnit6Curtailment()">Unit 6 Curtailment</button>
                    <button type="button" class="quick-action-btn" onclick="copyFromPrior(2)">Copy Prior Year</button>
                </div>
                
                <div class="use-factor-grid" id="grid-clifty">
                    <!-- Headers -->
                    <div class="grid-header">Month</div>
                    {% for m in range(1, 13) %}
                    <div class="grid-header">
                        {{ ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m-1] }}
                        {% if m >= 5 and m <= 9 %}<span class="ozone-indicator">O3</span>{% endif %}
                    </div>
                    {% endfor %}
                    
                    <!-- Base Use Factor Row -->
                    <div class="grid-label">Base</div>
                    {% for m in range(1, 13) %}
                    <div class="grid-cell">
                        <input type="number" 
                               name="cc_base_{{ m }}" 
                               id="cc_base_{{ m }}"
                               value="{{ clifty_factors[m].base if clifty_factors else 85 }}"
                               min="0" max="100" step="1"
                               data-plant="cc" data-type="base" data-month="{{ m }}"
                               onchange="markChanged(this)">
                    </div>
                    {% endfor %}
                    
                    <!-- Unit 6 (Non-SCR) Use Factor Row -->
                    <div class="grid-label">Unit 6</div>
                    {% for m in range(1, 13) %}
                    <div class="grid-cell">
                        <input type="number" 
                               name="cc_ozone_{{ m }}" 
                               id="cc_ozone_{{ m }}"
                               value="{{ clifty_factors[m].ozone_non_scr if clifty_factors else (0 if m >= 5 and m <= 9 else 85) }}"
                               min="0" max="100" step="1"
                               class="{% if m >= 5 and m <= 9 %}ozone-active{% endif %}"
                               data-plant="cc" data-type="ozone" data-month="{{ m }}"
                               onchange="markChanged(this)">
                    </div>
                    {% endfor %}
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <span class="legend-color ozone"></span>
                        <span>Ozone Season (May-Sep) - Unit 6 typically curtailed due to no SCR</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color changed"></span>
                        <span>Modified value</span>
                    </div>
                </div>
            </div>
            
            <!-- Summary Panel -->
            <div class="summary-panel">
                <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #1e3a5f;">Annual Summary</h3>
                <div id="use-factor-summary">
                    <div class="summary-row">
                        <span class="summary-label">Kyger Creek Avg Use Factor</span>
                        <span class="summary-value" id="kc-avg">85.0%</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Clifty Creek Avg Use Factor (excl. Unit 6)</span>
                        <span class="summary-value" id="cc-avg">85.0%</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Clifty Unit 6 Avg Use Factor</span>
                        <span class="summary-value" id="cc-u6-avg">42.5%</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">System Weighted Avg</span>
                        <span class="summary-value" id="system-avg">81.2%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="step-actions">
            <a href="/fuel-forecast/{{ session_id }}/step/3" class="btn btn-secondary">
                ← Back
            </a>
            <button type="submit" class="btn btn-primary">
                Save & Continue →
            </button>
        </div>
    </form>
</div>

<script>
// Mark input as changed
function markChanged(input) {
    input.classList.add('changed');
    updateSummary();
}

// Apply flat use factor to all months
function applyFlat(plantId, value) {
    const prefix = plantId === 1 ? 'kc' : 'cc';
    for (let m = 1; m <= 12; m++) {
        const input = document.getElementById(`${prefix}_base_${m}`);
        if (input) {
            input.value = value;
            input.classList.add('changed');
        }
    }
    updateSummary();
}

// Apply seasonal pattern
function applySeasonal(plantId) {
    const prefix = plantId === 1 ? 'kc' : 'cc';
    const pattern = [90, 85, 80, 75, 85, 95, 100, 95, 85, 80, 85, 90];
    for (let m = 1; m <= 12; m++) {
        const input = document.getElementById(`${prefix}_base_${m}`);
        if (input) {
            input.value = pattern[m-1];
            input.classList.add('changed');
        }
    }
    updateSummary();
}

// Apply Unit 6 curtailment during ozone season
function applyUnit6Curtailment() {
    for (let m = 1; m <= 12; m++) {
        const input = document.getElementById(`cc_ozone_${m}`);
        if (input) {
            // Curtail to 0 during ozone season (May-Sep)
            if (m >= 5 && m <= 9) {
                input.value = 0;
            } else {
                // Match base factor outside ozone season
                const baseInput = document.getElementById(`cc_base_${m}`);
                input.value = baseInput ? baseInput.value : 85;
            }
            input.classList.add('changed');
        }
    }
    updateSummary();
}

// Copy from prior year (placeholder - would need API call)
function copyFromPrior(plantId) {
    // In a real implementation, this would fetch prior year data via API
    alert('Copy from prior year: This would load values from the previous forecast year.');
}

// Update summary calculations
function updateSummary() {
    // Calculate Kyger average
    let kcSum = 0;
    for (let m = 1; m <= 12; m++) {
        const input = document.getElementById(`kc_base_${m}`);
        kcSum += input ? parseFloat(input.value) || 0 : 0;
    }
    document.getElementById('kc-avg').textContent = (kcSum / 12).toFixed(1) + '%';
    
    // Calculate Clifty base average
    let ccSum = 0;
    for (let m = 1; m <= 12; m++) {
        const input = document.getElementById(`cc_base_${m}`);
        ccSum += input ? parseFloat(input.value) || 0 : 0;
    }
    document.getElementById('cc-avg').textContent = (ccSum / 12).toFixed(1) + '%';
    
    // Calculate Clifty Unit 6 average
    let u6Sum = 0;
    for (let m = 1; m <= 12; m++) {
        const input = document.getElementById(`cc_ozone_${m}`);
        u6Sum += input ? parseFloat(input.value) || 0 : 0;
    }
    document.getElementById('cc-u6-avg').textContent = (u6Sum / 12).toFixed(1) + '%';
    
    // Calculate weighted system average
    // KC: 5 units, CC: 5 units base + 1 unit ozone factor
    const kcWeight = 5;
    const ccBaseWeight = 5;
    const ccU6Weight = 1;
    const totalWeight = kcWeight + ccBaseWeight + ccU6Weight;
    
    const systemAvg = ((kcSum / 12) * kcWeight + 
                       (ccSum / 12) * ccBaseWeight + 
                       (u6Sum / 12) * ccU6Weight) / totalWeight;
    document.getElementById('system-avg').textContent = systemAvg.toFixed(1) + '%';
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateSummary();
});
</script>
{% endblock %}

