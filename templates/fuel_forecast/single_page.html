{% extends "base.html" %}

{% block title %}Fuel Forecast - {{ year }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/fuel_forecast.css">
<style>
    .forecast-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .forecast-header h1 {
        margin: 0;
        font-size: 1.5rem;
    }
    
    .forecast-header .meta {
        display: flex;
        gap: 1.5rem;
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    /* Collapsible Section */
    .forecast-section {
        background: white;
        border-radius: 12px;
        margin-bottom: 1rem;
        border: 1px solid #d1d9e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        cursor: pointer;
        user-select: none;
        transition: all 0.2s;
    }
    
    .section-header:hover {
        background: linear-gradient(135deg, #f1f5f9 0%, #e8eef5 100%);
    }
    
    .section-header.expanded {
        border-bottom: 1px solid #d1d9e6;
    }
    
    .section-header h2 {
        margin: 0;
        font-size: 1rem;
        color: #1e3a5f;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .section-header .icon {
        font-size: 1.25rem;
    }
    
    .section-header .badge {
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 500;
        margin-left: 0.5rem;
    }
    
    .badge-optional {
        background: #e8eef5;
        color: #1e3a5f;
    }
    
    .badge-required {
        background: #fef3c7;
        color: #92400e;
    }
    
    .section-toggle {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        transition: transform 0.2s;
    }
    
    .section-header.expanded .section-toggle {
        transform: rotate(180deg);
    }
    
    .section-body {
        padding: 1.5rem;
        display: none;
    }
    
    .section-body.expanded {
        display: block;
    }
    
    /* Form Layout */
    .form-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-row-2 {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .form-row-3 {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .form-group label {
        font-size: 0.8rem;
        font-weight: 500;
        color: #374151;
    }
    
    .form-control {
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.95rem;
        background: white;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #1e3a5f;
        box-shadow: 0 0 0 2px rgba(30, 58, 95, 0.15);
    }
    
    .input-with-unit {
        position: relative;
    }
    
    .input-with-unit input {
        width: 100%;
        padding-right: 3rem;
        text-align: right;
    }
    
    .input-with-unit .unit {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    /* Subsection */
    .subsection {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .subsection:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .subsection-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .help-text {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 0.75rem;
    }
    
    /* Use Factor Grid */
    .uf-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 0.5rem;
    }
    
    .uf-cell {
        text-align: center;
    }
    
    .uf-cell label {
        display: block;
        font-size: 0.7rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }
    
    .uf-cell input {
        width: 100%;
        padding: 0.5rem;
        text-align: center;
        font-size: 0.9rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
    }
    
    /* Plant Tabs */
    .plant-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .plant-tab {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.9rem;
        color: #6b7280;
        background: #f1f5f9;
        border: 1px solid #e5e7eb;
        transition: all 0.2s;
    }
    
    .plant-tab:hover {
        color: #1e3a5f;
        background: #e8eef5;
    }
    
    .plant-tab.active {
        color: white;
        background: #1e3a5f;
        border-color: #1e3a5f;
    }
    
    .plant-content {
        display: none;
    }
    
    .plant-content.active {
        display: block;
    }
    
    /* Contracts Table */
    .contracts-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    
    .contracts-table th,
    .contracts-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .contracts-table th {
        background: #f8fafc;
        font-weight: 600;
        color: #374151;
        font-size: 0.75rem;
        text-transform: uppercase;
    }
    
    .contracts-table .value {
        font-family: 'JetBrains Mono', monospace;
        text-align: right;
    }
    
    /* Results Banner */
    .results-banner {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 12px;
        margin-top: 1.5rem;
        display: none;
    }
    
    .results-banner.visible {
        display: block;
    }
    
    .results-banner h3 {
        margin: 0 0 1rem 0;
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .results-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 2rem;
    }
    
    .result-item {
        text-align: center;
    }
    
    .result-label {
        font-size: 0.75rem;
        opacity: 0.8;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
    }
    
    .result-value {
        font-size: 1.75rem;
        font-weight: 700;
    }
    
    /* Action Bar */
    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #d1d9e6;
        margin-top: 1.5rem;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-primary {
        background: #1e3a5f;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2d4a6f;
    }
    
    .btn-success {
        background: #059669;
        color: white;
    }
    
    .btn-success:hover {
        background: #047857;
    }
    
    .btn-secondary {
        background: white;
        color: #374151;
        border: 1px solid #d1d5db;
    }
    
    .btn-secondary:hover {
        background: #f9fafb;
    }
    
    /* Loading */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .loading-overlay.visible {
        display: flex;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #d1d9e6;
        border-top-color: #1e3a5f;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
        .form-row { grid-template-columns: repeat(2, 1fr); }
        .uf-grid { grid-template-columns: repeat(6, 1fr); }
        .results-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 600px) {
        .form-row { grid-template-columns: 1fr; }
        .uf-grid { grid-template-columns: repeat(4, 1fr); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="forecast-header">
    <div>
        <h1>Fuel Forecast Workflow</h1>
        <div style="opacity: 0.8; font-size: 0.9rem; margin-top: 0.25rem;">
            Configure inputs and calculate fuel costs
        </div>
    </div>
    <div class="meta">
        <span>Year: {{ year }}</span>
        {% if scenario_name %}<span>Scenario: {{ scenario_name }}</span>{% endif %}
    </div>
</div>

<form id="forecastForm">
    <!-- Section 1: Starting Point -->
    <div class="forecast-section">
        <div class="section-header expanded" onclick="toggleSection(this)">
            <h2><span class="icon">üìÅ</span> Starting Point</h2>
            <span class="section-toggle">‚ñº</span>
        </div>
        <div class="section-body expanded">
            <div class="form-row form-row-2">
                <div class="form-group">
                    <label>Base Scenario</label>
                    <select name="base_scenario" class="form-control">
                        <option value="">Start Fresh (Use Defaults)</option>
                        {% for scenario in scenarios %}
                        <option value="{{ scenario.id }}" {% if scenario.id == selected_scenario_id %}selected{% endif %}>
                            {{ scenario.name }} ({{ scenario.created_at }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Scenario Name</label>
                    <input type="text" name="scenario_name" class="form-control" 
                           placeholder="e.g., {{ year }} Base Case" value="{{ scenario_name|default('') }}">
                </div>
            </div>
            <div class="help-text">
                Select an existing scenario to copy values from, or start fresh with defaults.
            </div>
        </div>
    </div>
    
    <!-- Section 2: Use Factors -->
    <div class="forecast-section">
        <div class="section-header" onclick="toggleSection(this)">
            <h2><span class="icon">üìä</span> Use Factors</h2>
            <span class="section-toggle">‚ñº</span>
        </div>
        <div class="section-body">
            <div class="plant-tabs">
                <button type="button" class="plant-tab active" onclick="switchPlantTab('uf-kc', this)">Kyger Creek</button>
                <button type="button" class="plant-tab" onclick="switchPlantTab('uf-cc', this)">Clifty Creek</button>
            </div>
            
            <div id="plant-uf-kc" class="plant-content active">
                <div class="uf-grid">
                    {% for m in range(1, 13) %}
                    <div class="uf-cell">
                        <label>{{ month_names[m][:3] }}</label>
                        <input type="number" name="uf_kc_{{ m }}" value="{{ use_factors_kc[m]|default(85) }}" min="0" max="100" step="1">
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div id="plant-uf-cc" class="plant-content">
                <div class="uf-grid">
                    {% for m in range(1, 13) %}
                    <div class="uf-cell">
                        <label>{{ month_names[m][:3] }}</label>
                        <input type="number" name="uf_cc_{{ m }}" value="{{ use_factors_cc[m]|default(85) }}" min="0" max="100" step="1">
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="help-text">
                Use factors determine generation as a percentage of available capacity. Lower values for outage months.
            </div>
        </div>
    </div>
    
    <!-- Section 3: Generation & Heat Rates -->
    <div class="forecast-section">
        <div class="section-header" onclick="toggleSection(this)">
            <h2><span class="icon">üî•</span> Generation & Heat Rates</h2>
            <span class="section-toggle">‚ñº</span>
        </div>
        <div class="section-body">
            <div class="subsection">
                <div class="subsection-title">Capacity</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>KC Capacity (MW)</label>
                        <input type="number" name="capacity_kc" class="form-control" value="{{ capacity_kc|default(1086) }}" step="1">
                    </div>
                    <div class="form-group">
                        <label>CC Capacity (MW)</label>
                        <input type="number" name="capacity_cc" class="form-control" value="{{ capacity_cc|default(1304) }}" step="1">
                    </div>
                    <div class="form-group">
                        <label>Reserve (MW)</label>
                        <input type="number" name="reserve_mw" class="form-control" value="{{ reserve_mw|default(5) }}" step="1">
                    </div>
                    <div class="form-group">
                        <label>Target Capacity Factor</label>
                        <div class="input-with-unit">
                            <input type="number" name="capacity_factor_target" class="form-control" value="{{ capacity_factor_target|default(85) }}" step="1">
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="subsection">
                <div class="subsection-title">Heat Rates</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>KC Base Heat Rate</label>
                        <div class="input-with-unit">
                            <input type="number" name="heat_rate_kc" class="form-control" value="{{ heat_rate_kc|default(9850) }}" step="10">
                            <span class="unit">BTU/kWh</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>CC Base Heat Rate</label>
                        <div class="input-with-unit">
                            <input type="number" name="heat_rate_cc" class="form-control" value="{{ heat_rate_cc|default(9900) }}" step="10">
                            <span class="unit">BTU/kWh</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>SUF Correction</label>
                        <div class="input-with-unit">
                            <input type="number" name="heat_rate_suf" class="form-control" value="{{ heat_rate_suf|default(0) }}" step="10">
                            <span class="unit">BTU/kWh</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>PRB Penalty</label>
                        <div class="input-with-unit">
                            <input type="number" name="heat_rate_prb_penalty" class="form-control" value="{{ heat_rate_prb_penalty|default(150) }}" step="10">
                            <span class="unit">BTU/kWh/%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="subsection">
                <div class="subsection-title">Deductions</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>FGD Auxiliary Load</label>
                        <div class="input-with-unit">
                            <input type="number" name="fgd_aux_pct" class="form-control" value="{{ fgd_aux_pct|default(2.5) }}" step="0.1">
                            <span class="unit">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>GSU Losses</label>
                        <div class="input-with-unit">
                            <input type="number" name="gsu_loss_pct" class="form-control" value="{{ gsu_loss_pct|default(0.5) }}" step="0.1">
                            <span class="unit">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Lack of Sales</label>
                        <div class="input-with-unit">
                            <input type="number" name="lack_of_sales_pct" class="form-control" value="{{ lack_of_sales_pct|default(0) }}" step="0.1">
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Section 4: Coal Inventory & Pricing -->
    <div class="forecast-section">
        <div class="section-header" onclick="toggleSection(this)">
            <h2><span class="icon">üí∞</span> Coal Inventory & Pricing</h2>
            <span class="section-toggle">‚ñº</span>
        </div>
        <div class="section-body">
            <div class="subsection">
                <div class="subsection-title">Inventory</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>KC Beginning Inventory</label>
                        <div class="input-with-unit">
                            <input type="number" name="inventory_kc" class="form-control" value="{{ inventory_kc|default(150000) }}" step="1000">
                            <span class="unit">tons</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>CC Beginning Inventory</label>
                        <div class="input-with-unit">
                            <input type="number" name="inventory_cc" class="form-control" value="{{ inventory_cc|default(175000) }}" step="1000">
                            <span class="unit">tons</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Target Inventory</label>
                        <div class="input-with-unit">
                            <input type="number" name="inventory_target_days" class="form-control" value="{{ inventory_target_days|default(45) }}" step="5">
                            <span class="unit">days</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Contracted Deliveries</label>
                        <div class="input-with-unit">
                            <input type="number" name="contracted_deliveries" class="form-control" value="{{ contracted_deliveries|default(250000) }}" step="5000">
                            <span class="unit">tons/mo</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="subsection">
                <div class="subsection-title">Coal Prices (FOB Mine)</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Eastern (NAPP)</label>
                        <div class="input-with-unit">
                            <input type="number" name="coal_price_eastern" class="form-control" value="{{ coal_price_eastern|default(55) }}" step="0.50">
                            <span class="unit">$/ton</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Illinois Basin</label>
                        <div class="input-with-unit">
                            <input type="number" name="coal_price_ilb" class="form-control" value="{{ coal_price_ilb|default(48) }}" step="0.50">
                            <span class="unit">$/ton</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>PRB</label>
                        <div class="input-with-unit">
                            <input type="number" name="coal_price_prb" class="form-control" value="{{ coal_price_prb|default(15) }}" step="0.50">
                            <span class="unit">$/ton</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Barge Transport</label>
                        <div class="input-with-unit">
                            <input type="number" name="barge_price" class="form-control" value="{{ barge_price|default(6) }}" step="0.25">
                            <span class="unit">$/ton</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="subsection">
                <div class="subsection-title">Coal Blend</div>
                <div class="form-row form-row-2">
                    <div class="form-group">
                        <label>KC PRB Blend</label>
                        <div class="input-with-unit">
                            <input type="number" name="prb_blend_kc" class="form-control" value="{{ prb_blend_kc|default(0) }}" min="0" max="100" step="5">
                            <span class="unit">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>CC PRB Blend</label>
                        <div class="input-with-unit">
                            <input type="number" name="prb_blend_cc" class="form-control" value="{{ prb_blend_cc|default(0) }}" min="0" max="100" step="5">
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Section 5: Escalation & Other Costs -->
    <div class="forecast-section">
        <div class="section-header" onclick="toggleSection(this)">
            <h2><span class="icon">üìà</span> Escalation & Other Costs <span class="badge badge-optional">Optional</span></h2>
            <span class="section-toggle">‚ñº</span>
        </div>
        <div class="section-body">
            <div class="subsection">
                <div class="subsection-title">Annual Escalation Rates</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Coal Price</label>
                        <div class="input-with-unit">
                            <input type="number" name="escalation_coal" class="form-control" value="{{ escalation_coal|default(2.5) }}" step="0.5">
                            <span class="unit">%/yr</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Transportation</label>
                        <div class="input-with-unit">
                            <input type="number" name="escalation_transport" class="form-control" value="{{ escalation_transport|default(3.0) }}" step="0.5">
                            <span class="unit">%/yr</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Reagents</label>
                        <div class="input-with-unit">
                            <input type="number" name="escalation_reagent" class="form-control" value="{{ escalation_reagent|default(2.0) }}" step="0.5">
                            <span class="unit">%/yr</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Labor</label>
                        <div class="input-with-unit">
                            <input type="number" name="escalation_labor" class="form-control" value="{{ escalation_labor|default(3.0) }}" step="0.5">
                            <span class="unit">%/yr</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="subsection">
                <div class="subsection-title">Reagent Costs (Annual)</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Limestone</label>
                        <div class="input-with-unit">
                            <input type="number" name="reagent_limestone" class="form-control" value="{{ reagent_limestone|default(2500000) }}" step="100000">
                            <span class="unit">$/yr</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ammonia</label>
                        <div class="input-with-unit">
                            <input type="number" name="reagent_ammonia" class="form-control" value="{{ reagent_ammonia|default(1800000) }}" step="100000">
                            <span class="unit">$/yr</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Other Consumables</label>
                        <div class="input-with-unit">
                            <input type="number" name="reagent_other" class="form-control" value="{{ reagent_other|default(500000) }}" step="50000">
                            <span class="unit">$/yr</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Results Banner -->
<div class="results-banner" id="resultsBanner">
    <h3>Forecast Results</h3>
    <div class="results-grid">
        <div class="result-item">
            <div class="result-label">Total Generation</div>
            <div class="result-value" id="result_mwh">-</div>
        </div>
        <div class="result-item">
            <div class="result-label">Coal Consumed</div>
            <div class="result-value" id="result_coal">-</div>
        </div>
        <div class="result-item">
            <div class="result-label">Total Fuel Cost</div>
            <div class="result-value" id="result_cost">-</div>
        </div>
        <div class="result-item">
            <div class="result-label">Avg $/MWh</div>
            <div class="result-value" id="result_rate">-</div>
        </div>
    </div>
</div>

<!-- Action Bar -->
<div class="action-bar">
    <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset to Defaults</button>
    <div style="display: flex; gap: 1rem;">
        <button type="button" class="btn btn-primary" onclick="calculateForecast()">Calculate</button>
        <button type="button" class="btn btn-success" onclick="saveForecast()">Save Scenario</button>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle sections
function toggleSection(header) {
    header.classList.toggle('expanded');
    header.nextElementSibling.classList.toggle('expanded');
}

// Switch plant tabs
function switchPlantTab(plantId, button) {
    const section = button.closest('.section-body');
    section.querySelectorAll('.plant-tab').forEach(tab => tab.classList.remove('active'));
    button.classList.add('active');
    section.querySelectorAll('.plant-content').forEach(panel => panel.classList.remove('active'));
    document.getElementById('plant-' + plantId).classList.add('active');
}

// Gather form data
function gatherFormData() {
    const form = document.getElementById('forecastForm');
    const formData = new FormData(form);
    const data = {};
    for (const [key, value] of formData.entries()) {
        data[key] = isNaN(parseFloat(value)) ? value : parseFloat(value);
    }
    return data;
}

// Calculate forecast
async function calculateForecast() {
    document.getElementById('loadingOverlay').classList.add('visible');
    
    try {
        const data = gatherFormData();
        const response = await fetch('/api/fuel-forecast/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) throw new Error('Calculation failed');
        
        const result = await response.json();
        
        document.getElementById('result_mwh').textContent = 
            (result.total_mwh / 1000000).toFixed(1) + ' TWh';
        document.getElementById('result_coal').textContent = 
            (result.total_coal_tons / 1000000).toFixed(2) + 'M tons';
        document.getElementById('result_cost').textContent = 
            '$' + (result.total_fuel_cost / 1000000).toFixed(1) + 'M';
        document.getElementById('result_rate').textContent = 
            '$' + result.avg_cost_per_mwh.toFixed(2);
        
        document.getElementById('resultsBanner').classList.add('visible');
        document.getElementById('resultsBanner').scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error calculating forecast: ' + error.message);
    } finally {
        document.getElementById('loadingOverlay').classList.remove('visible');
    }
}

// Save forecast
async function saveForecast() {
    const scenarioName = document.querySelector('[name="scenario_name"]').value;
    if (!scenarioName.trim()) {
        alert('Please enter a scenario name before saving.');
        document.querySelector('[name="scenario_name"]').focus();
        return;
    }
    
    document.getElementById('loadingOverlay').classList.add('visible');
    
    try {
        const data = gatherFormData();
        const response = await fetch('/api/fuel-forecast/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) throw new Error('Save failed');
        
        const result = await response.json();
        alert('Scenario "' + scenarioName + '" saved successfully!');
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving forecast: ' + error.message);
    } finally {
        document.getElementById('loadingOverlay').classList.remove('visible');
    }
}

// Reset form
function resetForm() {
    if (!confirm('Reset all values to defaults?')) return;
    document.getElementById('forecastForm').reset();
    document.getElementById('resultsBanner').classList.remove('visible');
}
</script>
{% endblock %}
