{% extends "base.html" %}

{% block title %}Coal Contracts{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-left">
        <h1>Coal Contracts <span class="subtitle">Supply Agreements</span></h1>
    </div>
    <div class="header-right">
        <a href="/coal-contracts/import" class="btn btn-secondary" style="margin-right: 0.5rem;">Import</a>
        <a href="/coal-contracts/new" class="btn btn-primary">+ New</a>
    </div>
</div>

<!-- Summary Bar (compact like Fuel View) -->
<div class="budget-summary">
    <div class="summary-item highlight">
        <span class="label">Active Contracts</span>
        <span class="value">{{ active_count or 0 }}</span>
    </div>
    <div class="summary-item highlight">
        <span class="label">Annual Tonnage</span>
        <span class="value">{{ "{:,.0f}".format(total_annual_tons or 0) }} tons</span>
    </div>
    <div class="summary-item">
        <span class="label">Avg $/Ton</span>
        <span class="value">${{ "{:.2f}".format(avg_delivered_cost or 0) }}</span>
    </div>
    <div class="summary-item">
        <span class="label">Kyger Contracts</span>
        <span class="value">{{ kyger_count or 0 }}</span>
    </div>
    <div class="summary-item">
        <span class="label">Clifty Contracts</span>
        <span class="value">{{ clifty_count or 0 }}</span>
    </div>
</div>

<!-- Filters Row -->
<div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap;">
    <select id="filter-plant" onchange="applyFilters()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d9e6;">
        <option value="">All Plants</option>
        <option value="1">Kyger Creek</option>
        <option value="2">Clifty Creek</option>
    </select>
    <select id="filter-status" onchange="applyFilters()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d9e6;">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
    </select>
    <input type="text" id="filter-supplier" placeholder="Search supplier..." oninput="applyFilters()" 
           style="padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d9e6; width: 200px;">
</div>

<!-- Contracts Table -->
<h2 class="section-title">Contract Summary</h2>
{% if contracts and contracts|length > 0 %}
<div class="grid-container" style="overflow-x: auto;">
    <table class="data-grid">
        <thead>
            <tr>
                <th style="text-align: left;">Supplier</th>
                <th style="text-align: left;">Contract ID</th>
                <th style="text-align: left;">Plant</th>
                <th class="align-right">Annual Tons</th>
                <th class="align-right">Coal $/Ton</th>
                <th class="align-right">Barge $/Ton</th>
                <th class="align-right">Delivered</th>
                <th class="align-right">BTU/lb</th>
                <th style="text-align: center;">Term</th>
                <th style="text-align: center;">Status</th>
            </tr>
        </thead>
        <tbody>
            {% for contract in contracts %}
            <tr class="contract-row" data-contract-id="{{ contract.id }}" 
                data-plant-id="{{ contract.plant_id }}" 
                data-status="{{ 'active' if contract.is_active else 'inactive' }}"
                data-supplier="{{ contract.supplier|lower }}"
                style="cursor: pointer;" 
                onclick="window.location.href='/coal-contracts/{{ contract.id }}'">
                <td style="font-weight: 600; color: #1e3a5f;">{{ contract.supplier }}</td>
                <td style="color: #6b7280; font-size: 0.85rem;">{{ contract.contract_id }}</td>
                <td>
                    <span style="padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; 
                          background: {% if contract.plant_id == 1 %}#dbeafe{% else %}#fce7f3{% endif %}; 
                          color: {% if contract.plant_id == 1 %}#1e40af{% else %}#9d174d{% endif %};">
                        {% if contract.plant_id == 1 %}Kyger{% else %}Clifty{% endif %}
                    </span>
                </td>
                <td class="align-right">{{ "{:,.0f}".format(contract.annual_tons) }}</td>
                <td class="align-right">${{ "{:.2f}".format(contract.coal_price_per_ton) }}</td>
                <td class="align-right">${{ "{:.2f}".format(contract.barge_price_per_ton) }}</td>
                <td class="align-right" style="font-weight: 600; color: #059669;">${{ "{:.2f}".format(contract.delivered_cost_per_ton) }}</td>
                <td class="align-right">{{ "{:,.0f}".format(contract.btu_per_lb) }}</td>
                <td style="text-align: center; font-size: 0.8rem; color: #6b7280;">
                    {{ contract.start_date.strftime('%b %y') }} - {{ contract.end_date.strftime('%b %y') }}
                </td>
                <td style="text-align: center;">
                    {% if contract.is_active %}
                    <span style="display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; background: #d1fae5; color: #065f46;">Active</span>
                    {% else %}
                    <span style="display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; background: #fee2e2; color: #991b1b;">Inactive</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="totals-row">
                <td colspan="3" style="font-weight: 600;">Total ({{ contracts|length }} contracts)</td>
                <td class="align-right" style="font-weight: 600;">{{ "{:,.0f}".format(total_annual_tons or 0) }}</td>
                <td colspan="2"></td>
                <td class="align-right" style="font-weight: 600;">${{ "{:.2f}".format(avg_delivered_cost or 0) }} avg</td>
                <td colspan="3"></td>
            </tr>
        </tfoot>
    </table>
</div>
{% else %}
<div style="text-align: center; padding: 3rem; background: #f8fafc; border-radius: 8px; border: 1px solid #d1d9e6;">
    <h3 style="color: #1e3a5f; margin-bottom: 0.5rem;">No Contracts Found</h3>
    <p style="color: #6b7280; margin-bottom: 1rem;">Get started by creating a new contract or importing from Excel.</p>
    <a href="/coal-contracts/new" class="btn btn-primary">+ Create First Contract</a>
</div>
{% endif %}

<!-- Plant Breakdown -->
{% if contracts and contracts|length > 0 %}
<h2 class="section-title">By Plant</h2>
<div class="system-comparison">
    <div class="plant-summary">
        <h3>Kyger Creek</h3>
        <div class="metric-row">
            <span class="metric-label">Contracts</span>
            <span class="metric-value">{{ kyger_count or 0 }}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Annual Tonnage</span>
            <span class="metric-value">{{ "{:,.0f}".format(kyger_tons or 0) }} tons</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Avg Delivered Cost</span>
            <span class="metric-value">${{ "{:.2f}".format(kyger_avg_cost or 0) }}/ton</span>
        </div>
    </div>
    
    <div class="plant-summary">
        <h3>Clifty Creek</h3>
        <div class="metric-row">
            <span class="metric-label">Contracts</span>
            <span class="metric-value">{{ clifty_count or 0 }}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Annual Tonnage</span>
            <span class="metric-value">{{ "{:,.0f}".format(clifty_tons or 0) }} tons</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Avg Delivered Cost</span>
            <span class="metric-value">${{ "{:.2f}".format(clifty_avg_cost or 0) }}/ton</span>
        </div>
    </div>
</div>
{% endif %}

<script>
function applyFilters() {
    const plant = document.getElementById('filter-plant').value;
    const status = document.getElementById('filter-status').value;
    const supplier = document.getElementById('filter-supplier').value.toLowerCase();
    
    const rows = document.querySelectorAll('.contract-row');
    
    rows.forEach(row => {
        let show = true;
        
        if (plant && row.dataset.plantId !== plant) {
            show = false;
        }
        
        if (status && row.dataset.status !== status) {
            show = false;
        }
        
        if (supplier && !row.dataset.supplier.includes(supplier)) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}
</script>
{% endblock %}
