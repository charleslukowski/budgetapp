{% extends "fuel_forecast/_layout.html" %}

{% block step_content %}
<style>
/* Outage Matrix - Clean spreadsheet aesthetic */
.outage-matrix {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 13px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.outage-matrix th,
.outage-matrix td {
    padding: 6px 3px;
    text-align: center;
    border-bottom: 1px solid #e5e7eb;
    border-right: 1px solid #e5e7eb;
}

.outage-matrix th:last-child,
.outage-matrix td:last-child {
    border-right: none;
}

.outage-matrix tbody tr:last-child td {
    border-bottom: 1px solid #d1d5db;
}

/* Header styling - lighter, more refined */
.outage-matrix th {
    background: #f8fafc;
    color: #374151;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 2px solid #d1d5db;
}

.outage-matrix th.unit-header {
    background: #f1f5f9;
    width: 75px;
    text-align: left;
    padding-left: 10px;
    color: #1e3a5f;
}

.outage-matrix th.month-header {
    min-width: 44px;
}

/* Ozone season months - subtle amber accent */
.outage-matrix th.month-header.ozone {
    background: #fffbeb;
    color: #92400e;
    border-bottom-color: #f59e0b;
}

/* Unit column styling */
.outage-matrix td.unit-col {
    font-weight: 600;
    background: #f8fafc;
    color: #1e3a5f;
    text-align: left;
    padding-left: 10px;
    border-right: 2px solid #e5e7eb;
    white-space: nowrap;
}

.outage-matrix td.unit-col.no-scr {
    background: linear-gradient(90deg, #fef3c7 0%, #f8fafc 100%);
    color: #92400e;
}

/* Cell styling - clean white background */
.outage-matrix td.cell {
    padding: 4px 2px;
    background: white;
    transition: background 0.15s ease;
}

/* Subtle highlight for cells with values */
.outage-matrix td.cell.partial {
    background: #fffbeb;
}

.outage-matrix td.cell.major {
    background: #fef2f2;
}

/* Ozone restricted - subtle left border instead of stripes */
.outage-matrix td.cell.ozone-restricted {
    border-left: 3px solid #f59e0b;
    padding-left: 3px;
}

/* Input styling - compact */
.outage-matrix td input {
    width: 42px;
    padding: 5px 2px;
    border: 1px solid #e5e7eb;
    border-radius: 3px;
    text-align: center;
    font-size: 13px;
    font-weight: 500;
    color: #374151;
    transition: all 0.15s ease;
    background: white;
}

.outage-matrix td input:hover {
    border-color: #d1d5db;
}

.outage-matrix td input:focus {
    outline: none;
    border-color: #2d4a6f;
    box-shadow: 0 0 0 2px rgba(45, 74, 111, 0.15);
    background: white;
}

/* Input with values */
.outage-matrix td input.has-value {
    background: #fffbeb;
    border-color: #fbbf24;
    color: #92400e;
    font-weight: 600;
}

.outage-matrix td input.full-outage {
    background: #fef2f2;
    border-color: #f87171;
    color: #dc2626;
    font-weight: 700;
}

/* Row hover - subtle highlight */
.outage-matrix tbody tr:hover td.cell {
    background: #f8fafc;
}

.outage-matrix tbody tr:hover td.cell.partial {
    background: #fef3c7;
}

.outage-matrix tbody tr:hover td.cell.major {
    background: #fee2e2;
}

/* Unit total column */
.outage-matrix .unit-total {
    font-weight: 600;
    background: #f1f5f9;
    color: #374151;
    font-family: 'JetBrains Mono', 'Consolas', monospace;
    font-size: 12px;
}

.outage-matrix .unit-total.high-outage {
    background: #fee2e2;
    color: #dc2626;
}

/* Footer totals */
.outage-matrix tfoot td {
    background: #f1f5f9;
    font-weight: 600;
    font-size: 12px;
    color: #374151;
    border-top: 2px solid #d1d5db;
    font-family: 'JetBrains Mono', 'Consolas', monospace;
}

.outage-matrix tfoot td.unit-col {
    background: #e8eef5;
    color: #1e3a5f;
}

/* Type selector */
.outage-type-selector {
    margin-top: 16px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.outage-type-selector h4 {
    margin: 0 0 12px 0;
    font-size: 13px;
    font-weight: 600;
    color: #374151;
}

.type-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.type-btn {
    padding: 8px 16px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: #374151;
    transition: all 0.15s ease;
}

.type-btn:hover {
    border-color: #2d4a6f;
    background: #f0f4f8;
}

.type-btn.active {
    border-color: #1e3a5f;
    background: #1e3a5f;
    color: white;
}

/* Template Palette */
.template-palette {
    margin: 16px 0;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.template-palette h4 {
    margin: 0 0 12px 0;
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.template-grid {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.template-chip {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    background: white;
    border: 1px solid #d1d5db;
    color: #374151;
}

.template-chip:hover {
    border-color: #9ca3af;
    background: #f9fafb;
}

.template-chip.selected {
    border-color: #1e3a5f;
    background: #1e3a5f;
    color: white;
}

.template-chip .days {
    background: #e5e7eb;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    color: #6b7280;
}

.template-chip.selected .days {
    background: rgba(255,255,255,0.2);
    color: white;
}

.template-instructions {
    margin-top: 12px;
    font-size: 12px;
    color: #6b7280;
    padding: 10px 12px;
    background: #fffbeb;
    border-radius: 6px;
    border-left: 3px solid #f59e0b;
}

/* Summary Card */
.summary-card {
    padding: 20px;
    background: white;
    border-radius: 8px;
    margin-top: 24px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

.summary-card h4 {
    margin: 0 0 16px 0;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    padding-bottom: 12px;
    border-bottom: 1px solid #e5e7eb;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 20px;
}

.summary-item {
    text-align: center;
    padding: 12px;
    background: #f8fafc;
    border-radius: 6px;
}

.summary-item .value {
    font-size: 24px;
    font-weight: 700;
    color: #1e3a5f;
    font-family: 'JetBrains Mono', 'Consolas', monospace;
}

.summary-item .label {
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #6b7280;
    margin-top: 6px;
}

/* Plant Section */
.plant-section {
    margin-bottom: 32px;
}

.plant-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e5e7eb;
}

.plant-section-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1e3a5f;
}

.unit-note {
    font-size: 12px;
    padding: 6px 10px;
    background: #fffbeb;
    border-radius: 6px;
    color: #92400e;
    font-weight: 500;
    border: 1px solid #fde68a;
}

.total-outage-days {
    font-size: 13px;
    font-weight: 600;
    color: #1e3a5f;
    padding: 6px 12px;
    background: #e8eef5;
    border-radius: 6px;
    font-family: 'JetBrains Mono', 'Consolas', monospace;
}

/* Month total cells */
.outage-matrix .month-total {
    font-family: 'JetBrains Mono', 'Consolas', monospace;
    font-size: 12px;
}

/* Availability Bar */
.availability-bar {
    width: 100%;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 8px;
}

.availability-bar .fill {
    height: 100%;
    background: #10b981;
    transition: width 0.3s ease;
    border-radius: 3px;
}

.availability-bar .fill.low {
    background: #f59e0b;
}

.availability-bar .fill.critical {
    background: #ef4444;
}

/* Quick Fill Actions */
.quick-fill {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.quick-fill button {
    padding: 8px 14px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: #374151;
    transition: all 0.15s ease;
}

.quick-fill button:hover {
    border-color: #1e3a5f;
    background: #f0f4f8;
    color: #1e3a5f;
}

.quick-fill button:active {
    background: #e8eef5;
}
</style>

<div class="step-card">
    <div class="step-card-header">
        <h2>Unit Outage Schedule</h2>
        <p>Enter planned outage days by unit and month. This drives availability and EFOR calculations.</p>
    </div>
    
    <form method="POST" action="/fuel-forecast/{{ session_id }}/step/outages">
        <div class="step-card-body">
            
            <!-- Quick Actions -->
            <div class="quick-fill">
                <button type="button" onclick="clearAllOutages()">Clear All</button>
                <button type="button" onclick="copyFromPrior()">Copy from Prior Year</button>
                <button type="button" onclick="applyTypicalPattern()">Apply Typical Pattern</button>
            </div>
            
            <!-- Template Palette -->
            <div class="template-palette">
                <h4>
                    <span>Outage Templates</span>
                    <small style="font-weight: normal; color: #6b7280;">Click template, then click cells to apply</small>
                </h4>
                <div class="template-grid" id="template-grid">
                    <span class="loading">Loading templates...</span>
                </div>
                <div class="template-instructions" id="template-instructions" style="display: none;">
                    <strong id="selected-template-name"></strong> selected (<span id="selected-template-days"></span> days). 
                    Click on a cell in the matrix to apply this outage.
                    <button type="button" class="btn-link" onclick="deselectTemplate()">Cancel</button>
                </div>
            </div>
            
            <!-- Kyger Creek Section -->
            <div class="plant-section">
                <div class="plant-section-header">
                    <h3>Kyger Creek</h3>
                    <span class="total-outage-days" id="kc_total">0 unit-days</span>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="outage-matrix" id="matrix_kc">
                        <thead>
                            <tr>
                                <th class="unit-header">Unit</th>
                                {% for m, month_num in [('Jan', 1), ('Feb', 2), ('Mar', 3), ('Apr', 4), ('May', 5), ('Jun', 6), ('Jul', 7), ('Aug', 8), ('Sep', 9), ('Oct', 10), ('Nov', 11), ('Dec', 12)] %}
                                <th class="month-header {% if month_num in [5, 6, 7, 8, 9] %}ozone{% endif %}">{{ m }}</th>
                                {% endfor %}
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for unit in range(1, 6) %}
                            <tr>
                                <td class="unit-col">Unit {{ unit }}</td>
                                {% for month in range(1, 13) %}
                                <td class="cell available">
                                    <input type="number" 
                                           name="kc_{{ unit }}_{{ month }}" 
                                           id="kc_{{ unit }}_{{ month }}"
                                           value="{{ outage_matrix_kc.get(unit, {}).get(month, {}).get('planned_days', 0) }}"
                                           min="0" max="31" step="0.5"
                                           onchange="updateOutageSummary('kc')"
                                           onfocus="this.select()">
                                </td>
                                {% endfor %}
                                <td class="unit-total" id="kc_unit_{{ unit }}_total">0</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td class="unit-col">Monthly Total</td>
                                {% for month in range(1, 13) %}
                                <td class="month-total" id="kc_month_{{ month }}_total">0</td>
                                {% endfor %}
                                <td id="kc_grand_total">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <!-- Clifty Creek Section -->
            <div class="plant-section">
                <div class="plant-section-header">
                    <h3>Clifty Creek</h3>
                    <span class="unit-note">⚠️ Unit 6 has no SCR - restricted during ozone season</span>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="outage-matrix" id="matrix_cc">
                        <thead>
                            <tr>
                                <th class="unit-header">Unit</th>
                                {% for m, month_num in [('Jan', 1), ('Feb', 2), ('Mar', 3), ('Apr', 4), ('May', 5), ('Jun', 6), ('Jul', 7), ('Aug', 8), ('Sep', 9), ('Oct', 10), ('Nov', 11), ('Dec', 12)] %}
                                <th class="month-header {% if month_num in [5, 6, 7, 8, 9] %}ozone{% endif %}">{{ m }}</th>
                                {% endfor %}
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for unit in range(1, 7) %}
                            <tr>
                                <td class="unit-col {% if unit == 6 %}no-scr{% endif %}">
                                    Unit {{ unit }}{% if unit == 6 %} <small>(no SCR)</small>{% endif %}
                                </td>
                                {% for month in range(1, 13) %}
                                <td class="cell available {% if unit == 6 and month in [5, 6, 7, 8, 9] %}ozone-restricted{% endif %}">
                                    <input type="number" 
                                           name="cc_{{ unit }}_{{ month }}" 
                                           id="cc_{{ unit }}_{{ month }}"
                                           value="{{ outage_matrix_cc.get(unit, {}).get(month, {}).get('planned_days', 0) }}"
                                           min="0" max="31" step="0.5"
                                           onchange="updateOutageSummary('cc')"
                                           onfocus="this.select()">
                                </td>
                                {% endfor %}
                                <td class="unit-total" id="cc_unit_{{ unit }}_total">0</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td class="unit-col">Monthly Total</td>
                                {% for month in range(1, 13) %}
                                <td class="month-total" id="cc_month_{{ month }}_total">0</td>
                                {% endfor %}
                                <td id="cc_grand_total">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <!-- Summary Section -->
            <div class="summary-card">
                <h4>Availability & EFOR Summary</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="value" id="summary_total_outage_days">0</div>
                        <div class="label">Total Outage Days</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="summary_avg_availability">100%</div>
                        <div class="label">Est. Availability</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="summary_efor">5.0%</div>
                        <div class="label">Weighted EFOR</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="summary_kc_days">0</div>
                        <div class="label">Kyger Creek Days</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="summary_cc_days">0</div>
                        <div class="label">Clifty Creek Days</div>
                    </div>
                </div>
                
                <div style="margin-top: 16px;">
                    <label style="font-size: 13px; color: #374151;">System Availability</label>
                    <div class="availability-bar">
                        <div class="fill" id="availability_fill" style="width: 100%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Forced Outage Estimate Section -->
            <div class="form-section" style="margin-top: 24px;">
                <div class="form-section-title">Forced Outage Estimates</div>
                <p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">
                    Estimate forced outage rates for EFOR calculation. This affects cost projections.
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="forced_outage_rate_kc">Kyger Creek EFOR</label>
                        <div class="input-with-unit">
                            <input type="number" name="forced_outage_rate_kc" id="forced_outage_rate_kc" 
                                   class="form-control" 
                                   value="{{ forced_outage_rate_kc or 5 }}"
                                   step="0.5" min="0" max="30">
                            <span class="unit">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="forced_outage_rate_cc">Clifty Creek EFOR</label>
                        <div class="input-with-unit">
                            <input type="number" name="forced_outage_rate_cc" id="forced_outage_rate_cc" 
                                   class="form-control" 
                                   value="{{ forced_outage_rate_cc or 5 }}"
                                   step="0.5" min="0" max="30">
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="step-actions">
            <a href="/fuel-forecast/{{ session_id }}/step/5" class="btn btn-secondary">
                ← Back to Heat Rates
            </a>
            <button type="submit" class="btn btn-primary">
                Continue to Generation →
            </button>
        </div>
    </form>
</div>

<script>
// Days in each month (non-leap year)
const DAYS_IN_MONTH = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
const OZONE_MONTHS = [5, 6, 7, 8, 9]; // May through September

// Update outage summary calculations
function updateOutageSummary(plant) {
    const prefix = plant;
    const numUnits = plant === 'kc' ? 5 : 6;
    
    let grandTotal = 0;
    
    // Calculate unit totals
    for (let unit = 1; unit <= numUnits; unit++) {
        let unitTotal = 0;
        for (let month = 1; month <= 12; month++) {
            const input = document.getElementById(`${prefix}_${unit}_${month}`);
            const cell = input ? input.closest('td') : null;
            if (input) {
                const val = parseFloat(input.value) || 0;
                const daysInMonth = DAYS_IN_MONTH[month - 1];
                unitTotal += val;
                
                // Style input based on value
                input.classList.remove('has-value', 'full-outage');
                if (val > 0 && val < daysInMonth * 0.5) {
                    input.classList.add('has-value');
                } else if (val >= daysInMonth * 0.5) {
                    input.classList.add('full-outage');
                }
                
                // Color-code the cell
                if (cell) {
                    cell.classList.remove('available', 'partial', 'major');
                    if (val === 0) {
                        cell.classList.add('available');
                    } else if (val < 7) {
                        cell.classList.add('partial');
                    } else {
                        cell.classList.add('major');
                    }
                    
                    // Mark ozone restricted cells for Unit 6
                    if (plant === 'cc' && unit === 6 && OZONE_MONTHS.includes(month)) {
                        cell.classList.add('ozone-restricted');
                    }
                }
            }
        }
        
        const unitTotalEl = document.getElementById(`${prefix}_unit_${unit}_total`);
        if (unitTotalEl) {
            unitTotalEl.textContent = unitTotal.toFixed(1);
            unitTotalEl.classList.remove('high-outage');
            if (unitTotal > 60) unitTotalEl.classList.add('high-outage');
        }
        grandTotal += unitTotal;
    }
    
    // Calculate month totals
    for (let month = 1; month <= 12; month++) {
        let monthTotal = 0;
        for (let unit = 1; unit <= numUnits; unit++) {
            const input = document.getElementById(`${prefix}_${unit}_${month}`);
            if (input) {
                monthTotal += parseFloat(input.value) || 0;
            }
        }
        const monthTotalEl = document.getElementById(`${prefix}_month_${month}_total`);
        if (monthTotalEl) monthTotalEl.textContent = monthTotal.toFixed(1);
    }
    
    const grandTotalEl = document.getElementById(`${prefix}_grand_total`);
    if (grandTotalEl) grandTotalEl.textContent = grandTotal.toFixed(1);
    
    // Update overall summary
    updateOverallSummary();
}

function updateOverallSummary() {
    const kcTotal = parseFloat(document.getElementById('kc_grand_total')?.textContent || 0);
    const ccTotal = parseFloat(document.getElementById('cc_grand_total')?.textContent || 0);
    const totalDays = kcTotal + ccTotal;
    
    const totalOutageEl = document.getElementById('summary_total_outage_days');
    const kcDaysEl = document.getElementById('summary_kc_days');
    const ccDaysEl = document.getElementById('summary_cc_days');
    const availabilityEl = document.getElementById('summary_avg_availability');
    const eforEl = document.getElementById('summary_efor');
    
    if (totalOutageEl) totalOutageEl.textContent = totalDays.toFixed(0);
    if (kcDaysEl) kcDaysEl.textContent = kcTotal.toFixed(0);
    if (ccDaysEl) ccDaysEl.textContent = ccTotal.toFixed(0);
    
    // Calculate availability (using planned outage factor)
    // Total possible unit-days: (5 + 6) * 365 = 4,015
    const totalUnitDays = (5 + 6) * 365;
    const availability = Math.max(0, (1 - totalDays / totalUnitDays) * 100);
    if (availabilityEl) availabilityEl.textContent = availability.toFixed(1) + '%';
    
    // Calculate estimated EFOR (based on historical + planned impact)
    const forcedRateKC = parseFloat(document.getElementById('forced_outage_rate_kc')?.value || 5);
    const forcedRateCC = parseFloat(document.getElementById('forced_outage_rate_cc')?.value || 5);
    const avgEfor = (forcedRateKC * 5 + forcedRateCC * 6) / 11; // Weighted average
    if (eforEl) eforEl.textContent = avgEfor.toFixed(1) + '%';
    
    // Update availability bar
    const fill = document.getElementById('availability_fill');
    if (fill) {
        fill.style.width = availability + '%';
        fill.classList.remove('low', 'critical');
        if (availability < 85) fill.classList.add('critical');
        else if (availability < 95) fill.classList.add('low');
    }
}

async function clearAllOutages() {
    if (!confirm('Clear all outage data? This cannot be undone.')) return;
    
    // Clear in the UI first
    document.querySelectorAll('.outage-matrix input[type="number"]').forEach(input => {
        input.value = 0;
    });
    updateOutageSummary('kc');
    updateOutageSummary('cc');
    
    // Also clear in the database
    const year = {{ year or 2025 }};
    try {
        await fetch(`/api/unit-outages/1/${year}`, { method: 'DELETE' });
        await fetch(`/api/unit-outages/2/${year}`, { method: 'DELETE' });
    } catch (error) {
        console.warn('Could not clear database records:', error);
    }
}

async function copyFromPrior() {
    // Make API call to load prior year data
    const year = {{ year or 2025 }};
    const priorYear = year - 1;
    
    if (!confirm(`Copy outage data from ${priorYear} to ${year}?`)) return;
    
    try {
        // Copy for both plants
        const response1 = await fetch(`/api/unit-outages/copy/1/${priorYear}/${year}`, { method: 'POST' });
        const response2 = await fetch(`/api/unit-outages/copy/2/${priorYear}/${year}`, { method: 'POST' });
        
        if (response1.ok && response2.ok) {
            // Reload the page to show the copied data
            location.reload();
        } else {
            alert('Error copying data. Please try again.');
        }
    } catch (error) {
        console.error('Error copying outages:', error);
        alert('Error copying data: ' + error.message);
    }
}

function applyTypicalPattern() {
    // Apply a typical outage pattern (spring/fall for major overhauls)
    if (!confirm('Apply typical 21-day overhaul pattern? This will replace current values.')) return;
    
    // Clear first
    clearAllOutages();
    
    // Kyger Creek: Unit 1 in April (21 days), Unit 3 in October (21 days)
    const kc_1_4 = document.getElementById('kc_1_4');
    const kc_3_10 = document.getElementById('kc_3_10');
    if (kc_1_4) kc_1_4.value = 21;
    if (kc_3_10) kc_3_10.value = 21;
    
    // Clifty Creek: Unit 2 in April (21 days), Unit 4 in October (21 days)
    const cc_2_4 = document.getElementById('cc_2_4');
    const cc_4_10 = document.getElementById('cc_4_10');
    if (cc_2_4) cc_2_4.value = 21;
    if (cc_4_10) cc_4_10.value = 21;
    
    updateOutageSummary('kc');
    updateOutageSummary('cc');
}

function applyMajorOverhaul(plant, unit) {
    // Apply a major 28-day overhaul pattern
    const months = [4, 10]; // April or October
    const month = prompt(`Enter month (1-12) for Unit ${unit} major overhaul:`, '4');
    if (month && month >= 1 && month <= 12) {
        const input = document.getElementById(`${plant}_${unit}_${month}`);
        if (input) {
            input.value = 28;
            updateOutageSummary(plant);
        }
    }
}

function applyMinorInspection(plant, unit) {
    // Apply a 7-day inspection
    const month = prompt(`Enter month (1-12) for Unit ${unit} minor inspection:`, '3');
    if (month && month >= 1 && month <= 12) {
        const input = document.getElementById(`${plant}_${unit}_${month}`);
        if (input) {
            input.value = 7;
            updateOutageSummary(plant);
        }
    }
}

// =============================================================================
// Template System
// =============================================================================

let templates = [];
let selectedTemplate = null;

async function loadTemplates() {
    try {
        // First, ensure system templates are initialized
        await fetch('/api/outage-templates/init-system', { method: 'POST' });
        
        // Then load all templates
        const response = await fetch('/api/outage-templates/');
        if (response.ok) {
            templates = await response.json();
            renderTemplates();
        }
    } catch (error) {
        console.error('Error loading templates:', error);
        document.getElementById('template-grid').innerHTML = 
            '<span style="color: #dc2626;">Error loading templates</span>';
    }
}

function renderTemplates() {
    const grid = document.getElementById('template-grid');
    if (!templates.length) {
        grid.innerHTML = '<span>No templates available</span>';
        return;
    }
    
    grid.innerHTML = templates.map(t => `
        <div class="template-chip" 
             data-id="${t.id}" 
             data-days="${t.default_days}"
             style="border-color: ${t.color}"
             onclick="selectTemplate(${t.id})">
            <span style="width: 8px; height: 8px; background: ${t.color}; border-radius: 50%;"></span>
            ${t.name}
            <span class="days">${t.default_days}d</span>
        </div>
    `).join('');
}

function selectTemplate(templateId) {
    selectedTemplate = templates.find(t => t.id === templateId);
    
    // Update chip styles
    document.querySelectorAll('.template-chip').forEach(chip => {
        chip.classList.remove('selected');
        if (chip.dataset.id == templateId) {
            chip.classList.add('selected');
        }
    });
    
    // Show instructions
    document.getElementById('template-instructions').style.display = 'block';
    document.getElementById('selected-template-name').textContent = selectedTemplate.name;
    document.getElementById('selected-template-days').textContent = selectedTemplate.default_days;
    
    // Add click handlers to cells
    document.querySelectorAll('.outage-matrix td.cell').forEach(cell => {
        cell.style.cursor = 'pointer';
    });
}

function deselectTemplate() {
    selectedTemplate = null;
    document.querySelectorAll('.template-chip').forEach(chip => {
        chip.classList.remove('selected');
    });
    document.getElementById('template-instructions').style.display = 'none';
    document.querySelectorAll('.outage-matrix td.cell').forEach(cell => {
        cell.style.cursor = '';
    });
}

function handleCellClick(plant, unit, month) {
    if (!selectedTemplate) return;
    
    const input = document.getElementById(`${plant}_${unit}_${month}`);
    if (input) {
        input.value = selectedTemplate.default_days;
        updateOutageSummary(plant);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateOutageSummary('kc');
    updateOutageSummary('cc');
    
    // Load templates
    loadTemplates();
    
    // Add click handlers to cells for template application
    document.querySelectorAll('.outage-matrix td.cell').forEach(cell => {
        const input = cell.querySelector('input');
        if (input) {
            const [prefix, unit, month] = input.id.split('_');
            cell.addEventListener('click', function(e) {
                if (e.target.tagName === 'INPUT') return; // Don't intercept input clicks
                handleCellClick(prefix, unit, month);
            });
        }
    });
    
    // Also update when forced outage rates change
    const forcedKC = document.getElementById('forced_outage_rate_kc');
    const forcedCC = document.getElementById('forced_outage_rate_cc');
    if (forcedKC) forcedKC.addEventListener('change', updateOverallSummary);
    if (forcedCC) forcedCC.addEventListener('change', updateOverallSummary);
});
</script>

{% endblock %}

